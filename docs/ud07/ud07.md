# Tema 7. Modelo de Seguridad de AWS

## Modelo de Seguridad de AWS

El modelo de seguridad de AWS se basa en el principio de **responsabilidad compartida**: AWS asegura la **infraestructura**, y el cliente asegura **los datos y la configuraci√≥n** de sus servicios.


### Responsabilidad compartida

| Parte       | Qu√© asegura                                                                                                           |
| ----------- | --------------------------------------------------------------------------------------------------------------------- |
| **AWS**     | Seguridad de la **infraestructura f√≠sica**, hardware, redes, centros de datos y servicios gestionados.                |
| **Cliente** | Configuraci√≥n de los servicios, control de acceso, cifrado de datos, seguridad de aplicaciones y sistemas operativos. |

> Ejemplo: en **EC2**, AWS asegura el hardware y la red, pero nosotros debemos proteger nuestro sistema operativo, usuarios y aplicaciones.


### Identidad y acceso (IAM)

AWS gestiona la autenticaci√≥n y autorizaci√≥n mediante **IAM (Identity and Access Management)**:

* **Usuarios** y **grupos**: cuentas dentro de la organizaci√≥n.
* **Roles**: permisos temporales para servicios o usuarios externos.
* **Pol√≠ticas**: reglas que definen qu√© acciones puede realizar un usuario o servicio sobre un recurso.

### Cifrado de datos

AWS permite cifrar datos **en reposo** y **en tr√°nsito**:

* **En reposo:**

    * S3, EBS, RDS y DynamoDB soportan **cifrado con claves gestionadas por AWS (SSE)** o **propias (CMK)**.

* **En tr√°nsito:**

    * TLS/SSL para proteger la comunicaci√≥n entre servicios y clientes.


### Red y per√≠metro

AWS protege la red mediante servicios y configuraciones:

* **VPC (Virtual Private Cloud):** redes privadas aisladas en la nube.
* **Subredes, ACLs y Security Groups:** control granular de tr√°fico entrante y saliente.
* **AWS Shield y WAF:** protecci√≥n frente a ataques DDoS y filtrado de tr√°fico web malicioso.

### Monitorizaci√≥n y auditor√≠a

* **CloudTrail:** registro de **todas las acciones de API** realizadas en la cuenta.
* **CloudWatch:** monitorizaci√≥n de m√©tricas y eventos de los recursos.
* **GuardDuty:** detecci√≥n de amenazas mediante an√°lisis de logs y patrones sospechosos.


### Cumplimiento y certificaciones

AWS cumple con normas de seguridad y privacidad reconocidas internacionalmente.

Esto permite que las empresas conf√≠en en la infraestructura para **aplicaciones cr√≠ticas y reguladas**.


---

## AWS IAM (Identity and Access Management)

**AWS Identity and Access Management (IAM)** es el servicio de **gesti√≥n de identidades y control de acceso** de Amazon Web Services.
Permite **administrar de forma segura qui√©n puede acceder a los recursos de AWS y qu√© acciones puede realizar**.

IAM es **gratuito** (no tiene coste adicional) y se integra en todos los servicios de AWS.
Es un componente **central del modelo de seguridad de AWS** y se basa en el **principio de m√≠nimos privilegios**: cada usuario o servicio solo debe tener los permisos estrictamente necesarios para realizar su tarea.


### Usuario, Grupos, Roles y Pol√≠ticas

IAM se organiza alrededor de **identidades, pol√≠ticas y permisos**.

**Usuarios**

Representan **personas o aplicaciones** que necesitan acceder a AWS.

* Tienen **credenciales**: nombre de usuario y contrase√±a (para la consola web) o claves de acceso (para la CLI o APIs).
* Pueden a√±adirse a **grupos** o recibir permisos directamente.
* Ejemplo: `usuario_admin`, `usuario_lectura`, `aplicacion_api`.

**Grupos**

Conjuntos l√≥gicos de usuarios con permisos comunes.

* Sirven para **gestionar permisos de forma masiva**.
* Ejemplo: grupo `Desarrolladores` con permisos sobre instancias EC2 y buckets S3.

**Roles**

Identidades **sin credenciales propias**, dise√±adas para ser **asumidas temporalmente** por usuarios, servicios o recursos.

* Muy usados para otorgar permisos a **servicios de AWS** (como EC2 o Lambda) sin exponer claves.
* Ejemplo: una instancia EC2 que necesita leer un bucket S3 utiliza un **rol IAM** con ese permiso.

**Pol√≠ticas (Policies)**

Son **documentos en formato JSON** que **definen los permisos**.

Las vemos con dentenimiento en el siguiente apratado.


### Autorizaci√≥n: c√≥mo AWS decide si algo est√° permitido

Cada vez que un usuario o servicio hace una petici√≥n a AWS, IAM eval√∫a **todas las pol√≠ticas asociadas** y aplica una **l√≥gica de decisi√≥n**:

1. **Por defecto todo est√° denegado.**
2. Si una pol√≠tica **permite** la acci√≥n, pasa a estado *permitido provisionalmente*.
3. Si alguna pol√≠tica **deniega expl√≠citamente** una acci√≥n, la petici√≥n **se bloquea siempre**.

Esto se conoce como el modelo **Deny by default**.


### Roles y delegaci√≥n de permisos

Los **roles IAM** permiten **delegar permisos de forma temporal y controlada**.
Se usan, por ejemplo, para:

* Permitir que una **instancia EC2** acceda a un **bucket S3** sin usar claves.
* Conceder permisos temporales a **usuarios externos o cuentas de otra organizaci√≥n (cross-account roles)**.
* Autorizar a servicios de AWS (como Lambda o ECS) para actuar en nombre del usuario.

> **IAM es el coraz√≥n de la seguridad en AWS:** controla qui√©n entra, qu√© puede hacer y con qu√© recursos, garantizando una gesti√≥n centralizada, segura y flexible del acceso a la nube.



---

## Pol√≠ticas de IAM en AWS

### 1. ¬øQu√© son las pol√≠ticas en AWS IAM?

Las **pol√≠ticas** son **documentos en formato JSON** que definen los **permisos** que se conceden o deniegan a un usuario, grupo o rol en AWS.
En esencia, **una pol√≠tica indica qu√© acciones puede realizar un sujeto (usuario, grupo o rol) sobre qu√© recursos y bajo qu√© condiciones**.

Son el **n√∫cleo del modelo de control de acceso** en AWS: sin una pol√≠tica asociada, ning√∫n usuario o servicio tiene permisos.


* Especifican:

  * **Acciones** (`Action`): qu√© operaciones se permiten o deniegan.
  * **Recursos** (`Resource`): sobre qu√© objetos se aplican.
  * **Efecto** (`Effect`): `Allow` o `Deny`.
* Ejemplo de pol√≠tica simple:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:ListBucket", "s3:GetObject"],
      "Resource": ["arn:aws:s3:::mi-bucket", "arn:aws:s3:::mi-bucket/*"]
    }
  ]
}
```

---

### 2. Tipos de pol√≠ticas

AWS ofrece varios tipos de pol√≠ticas, clasificadas seg√∫n c√≥mo y d√≥nde se aplican:

| Tipo de pol√≠tica                 | Descripci√≥n                                                                                                  | Ejemplo                                                      |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------ |
| **Administradas por AWS**        | Pol√≠ticas predefinidas creadas y mantenidas por AWS. Simplifican la gesti√≥n y se actualizan autom√°ticamente. | `AmazonS3ReadOnlyAccess`, `AdministratorAccess`              |
| **Administradas por el cliente** | Pol√≠ticas personalizadas creadas por el usuario para definir permisos espec√≠ficos.                           | Pol√≠tica que permite acceso de lectura a un bucket concreto. |
| **Inline (insertadas)**          | Pol√≠ticas directamente incrustadas en un usuario, grupo o rol concreto. No son reutilizables.                | Pol√≠tica personalizada dentro de un rol de EC2.              |


---

### 3. Estructura y sintaxis de una pol√≠tica (JSON)

Las pol√≠ticas de IAM siguen una estructura **JSON** con campos obligatorios y opcionales:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::mi-bucket",
        "arn:aws:s3:::mi-bucket/*"
      ],
      "Condition": {
        "IpAddress": {
          "aws:SourceIp": "203.0.113.0/24"
        }
      }
    }
  ]
}
```

#### üîç Desglose de los campos:

| Campo         | Descripci√≥n                                                                                                             | Obligatorio |
| ------------- | ----------------------------------------------------------------------------------------------------------------------- | ----------- |
| **Version**   | Indica la versi√≥n del lenguaje de pol√≠ticas. Actualmente se usa `"2012-10-17"`.                                         | ‚úÖ           |
| **Statement** | Lista de reglas que definen permisos. Puede contener una o varias.                                                      | ‚úÖ           |
| **Effect**    | Determina si la acci√≥n se **permite** (`Allow`) o **deniega** (`Deny`).                                                 | ‚úÖ           |
| **Action**    | Especifica las **acciones** de AWS que se permiten o deniegan (por ejemplo, `s3:PutObject`, `ec2:StartInstances`).      | ‚úÖ           |
| **Resource**  | Indica los recursos espec√≠ficos sobre los que se aplican los permisos, usando su ARN.                                   | ‚úÖ           |
| **Condition** | Define condiciones opcionales (por IP, usuario, hora, MFA, etc.) que deben cumplirse para que se concedan los permisos. | ‚ùå           |

---

### 4. ARN (Amazon Resource Name)

Los **ARN (Amazon Resource Names)** identifican de forma √∫nica los recursos en AWS.

Ejemplo de estructura:

```
arn:aws:servicio:regi√≥n:cuenta:recurso
```

üìò Ejemplo para un bucket S3:

```
arn:aws:s3:::mi-bucket
arn:aws:s3:::mi-bucket/mis-archivos/*
```

---

### 5. Ejemplo pr√°ctico: pol√≠tica personalizada

**Objetivo:** Permitir a un usuario listar y leer objetos del bucket `asir-datos`, pero no borrarlos.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "LeerBucketASIR",
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket",
        "s3:GetObject"
      ],
      "Resource": [
        "arn:aws:s3:::asir-datos",
        "arn:aws:s3:::asir-datos/*"
      ]
    }
  ]
}
```

üìò *Sid (Statement ID)*: campo opcional para identificar el bloque de permisos.

---

### 6. Condiciones en pol√≠ticas (Conditions)

Las condiciones permiten aplicar **control contextual**.
Se definen mediante operadores y claves de condici√≥n.

Ejemplo: permitir acceso solo desde una IP concreta y con MFA activado.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "ec2:*",
      "Resource": "*",
      "Condition": {
        "IpAddress": {"aws:SourceIp": "192.0.2.0/24"},
        "Bool": {"aws:MultiFactorAuthPresent": "true"}
      }
    }
  ]
}
```

---

### 7. Principio del **menor privilegio**

Una **mejor pr√°ctica fundamental** en IAM es aplicar el **Principio del Menor Privilegio** (*Least Privilege*):

> Conceder solo los permisos m√≠nimos necesarios para realizar una tarea concreta.

Esto reduce el riesgo de accesos indebidos y da√±os accidentales.

---

### 8. Evaluaci√≥n de pol√≠ticas (c√≥mo AWS decide si algo est√° permitido)

Cuando un usuario intenta realizar una acci√≥n, AWS eval√∫a las pol√≠ticas siguiendo este orden:

1. **Denegaci√≥n expl√≠cita (Deny)** ‚Üí siempre prevalece.
2. **Permiso expl√≠cito (Allow)** ‚Üí concede acceso si no hay una denegaci√≥n previa.
3. **Por defecto, todo est√° denegado** hasta que una pol√≠tica lo permita.

üëâ **Regla de oro:**
Si no hay una pol√≠tica `Allow`, la acci√≥n no se ejecutar√°.

---

### 9. Creaci√≥n de pol√≠ticas en la consola de AWS

Pasos b√°sicos para crear una pol√≠tica personalizada:

1. En la consola, ir a **IAM ‚Üí Policies ‚Üí Create policy**.
2. Elegir entre el **modo visual** (seleccionar servicio, acciones, recursos) o **modo JSON**.
3. Revisar los permisos y guardar.
4. Asignar la pol√≠tica a un **usuario, grupo o rol**.

---

### 10. Buenas pr√°cticas con pol√≠ticas IAM

* ‚úÖ Usar **pol√≠ticas administradas por AWS** siempre que sea posible.
* üß© Crear **pol√≠ticas administradas por el cliente** para necesidades espec√≠ficas.
* üö´ Evitar el uso de `"Resource": "*"`, salvo en pol√≠ticas muy controladas.
* üïµÔ∏è‚Äç‚ôÇÔ∏è Revisar pol√≠ticas con **IAM Access Analyzer** para detectar permisos excesivos.
* üîê Activar **MFA (autenticaci√≥n multifactor)** y combinar con condiciones de acceso.
* üìú Versionar pol√≠ticas y usar nombres descriptivos.

---


---

## üß© **Asignaci√≥n de pol√≠ticas en AWS IAM**

Una vez creada una pol√≠tica (ya sea **administrada** o **personalizada**), el siguiente paso es **asignarla a una entidad de IAM**, que puede ser:

* Un **usuario** (identity individual).
* Un **grupo de usuarios** (para aplicar permisos comunes).
* Un **rol** (para servicios, cuentas externas o accesos temporales).

---

### üîπ **1. Asignar una pol√≠tica a un usuario**

#### Desde la **consola de AWS**:

1. Ve a **IAM ‚Üí Users**.
2. Selecciona el **usuario** al que quieres aplicar permisos.
3. En la pesta√±a **Permissions**, haz clic en **Add permissions**.
4. Elige una de las opciones:

   * **Attach policies directly** ‚Üí seleccionas una pol√≠tica existente (administrada o personalizada).
   * **Add user to group** ‚Üí si el grupo ya tiene la pol√≠tica asociada, el usuario hereda los permisos.
   * **Copy permissions from existing user** ‚Üí clona permisos de otro usuario.
5. Haz clic en **Next**, revisa y **Add permissions**.

üìò *Resultado:* el usuario ahora tiene los permisos definidos en la pol√≠tica.

---

### üîπ **2. Asignar una pol√≠tica a un grupo**

Esto es muy √∫til cuando varios usuarios necesitan los mismos permisos.

1. En **IAM ‚Üí User groups**, selecciona o crea un grupo.
2. En la pesta√±a **Permissions**, selecciona **Attach policy**.
3. Marca las pol√≠ticas que quieres aplicar y **Add permissions**.

üìò *Todos los usuarios del grupo heredan autom√°ticamente esas pol√≠ticas.*

---

### üîπ **3. Asignar una pol√≠tica a un rol**

Los **roles** se usan cuando una **entidad no humana (servicio o aplicaci√≥n)** necesita actuar con permisos temporales.

Ejemplo: una instancia **EC2** que necesita leer datos de **S3**.

#### Pasos:

1. Ve a **IAM ‚Üí Roles ‚Üí Create role**.
2. Elige el tipo de entidad que asumir√° el rol (por ejemplo, **EC2**).
3. En el paso de permisos, selecciona las pol√≠ticas que se aplicar√°n al rol.
4. N√≥mbralo y cr√©alo.
5. Asocia el rol a tu servicio (por ejemplo, al lanzar una instancia EC2).

üìò *El servicio asumir√° ese rol y obtendr√° temporalmente los permisos definidos.*

---

### üîπ **4. Desde la AWS CLI**

Tambi√©n puedes asociar pol√≠ticas desde la **l√≠nea de comandos**, usando el comando `aws iam attach-*`.

Ejemplos:

#### A un usuario:

```bash
aws iam attach-user-policy \
  --user-name usuario-asir \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
```

#### A un grupo:

```bash
aws iam attach-group-policy \
  --group-name grupo-asir \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess
```

#### A un rol:

```bash
aws iam attach-role-policy \
  --role-name rol-lectura-s3 \
  --policy-arn arn:aws:iam::123456789012:policy/LecturaS3Personalizada
```

---

### üîπ **5. Visualizaci√≥n de pol√≠ticas asociadas**

Desde la consola o CLI, puedes comprobar qu√© pol√≠ticas tiene una entidad:

**Consola:**

* En el perfil del usuario, grupo o rol ‚Üí pesta√±a **Permissions**.

**CLI:**

```bash
aws iam list-attached-user-policies --user-name usuario-asir
```

---

### üîπ **6. Prioridad y combinaci√≥n de pol√≠ticas**

AWS combina **todas las pol√≠ticas adjuntas** a una entidad (usuario + grupo + rol).
El resultado final es la **uni√≥n de todos los permisos `Allow`**, excepto si hay un **`Deny` expl√≠cito**, que **siempre prevalece**.

üìò Ejemplo:

* El grupo permite `s3:GetObject`.
* Una pol√≠tica inline en el usuario hace `Deny` sobre `s3:GetObject`.
  ‚Üí El acceso **se deniega**, porque el *Deny expl√≠cito* tiene prioridad.

---

### üîπ **7. Pol√≠ticas inline vs. adjuntas**

| Tipo                  | Descripci√≥n                                                                | Uso recomendado                         |
| --------------------- | -------------------------------------------------------------------------- | --------------------------------------- |
| **Adjunta (managed)** | Pol√≠tica independiente que se enlaza a uno o m√°s usuarios, grupos o roles. | üîπ Reutilizable y f√°cil de mantener.    |
| **Inline**            | Pol√≠tica escrita dentro del propio usuario, grupo o rol.                   | üîπ Para casos muy espec√≠ficos y √∫nicos. |

---

### ‚úÖ **Resumen r√°pido**

| Acci√≥n                      | D√≥nde se hace                      | Resultado                                 |
| --------------------------- | ---------------------------------- | ----------------------------------------- |
| **Attach policy a usuario** | IAM ‚Üí Users ‚Üí Add permissions      | Aplica directamente la pol√≠tica.          |
| **Attach policy a grupo**   | IAM ‚Üí Groups ‚Üí Attach policy       | Todos los usuarios heredan los permisos.  |
| **Attach policy a rol**     | IAM ‚Üí Roles ‚Üí Create/Attach policy | El servicio o entidad asume los permisos. |
| **CLI**                     | `aws iam attach-*`                 | Permite automatizar la asignaci√≥n.        |

---


